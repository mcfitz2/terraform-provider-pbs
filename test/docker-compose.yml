version: '3.8'

services:
  pbs:
    image: ${IMAGE:-ayufan/proxmox-backup-server:${TAG:-latest}}
    container_name: pbs-test
    ports:
      - "8007:8007"
    environment:
      - PBS_ROOT_PASSWORD=pbspbs
    mem_limit: 2G
    tmpfs:
      - /run
    cap_add:
      - SYS_RAWIO # smartctl support
    restart: unless-stopped
    stop_signal: SIGHUP
    healthcheck:
      test: ["CMD-SHELL", "curl -k -f https://localhost:8007 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 60s

  influxdb:
    image: influxdb:2.7
    container_name: influxdb-test
    ports:
      - "8086:8086"
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=adminpassword
      - DOCKER_INFLUXDB_INIT_ORG=testorg
      - DOCKER_INFLUXDB_INIT_BUCKET=pbs-metrics
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=test-token-123456
    mem_limit: 512M
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "influx ping || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  influxdb-udp:
    image: influxdb:1.8
    container_name: influxdb-udp-test
    ports:
      - "8089:8089/udp"
    environment:
      - INFLUXDB_UDP_ENABLED=true
      - INFLUXDB_UDP_BIND_ADDRESS=:8089
      - INFLUXDB_UDP_DATABASE=udp
    mem_limit: 512M
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "influx -execute 'SHOW DATABASES' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

networks:
  default:
    name: pbs-test-network