# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|
  # Use pre-built PBS box from mcfitz2/proxmox-backup-server
  # The box name will be set by CI workflow (e.g., "pbs-3.4" or "pbs-4.0")
  # For local testing (libvirt provider only), you can manually add a box:
  #   wget https://github.com/mcfitz2/proxmox-backup-server/releases/latest/download/proxmox-backup-server-3.4-amd64-libvirt.box
  #   vagrant box add pbs-3.4 proxmox-backup-server-3.4-amd64-libvirt.box
  config.vm.box = "pbs-3.4"  # Default for local testing, overridden by CI
  
  # Disable default synced folder (not needed for PBS VM, avoids NFS issues in CI)
  config.vm.synced_folder ".", "/vagrant", disabled: true
  
  # PBS VM configuration
  config.vm.define "pbs" do |pbs|
    pbs.vm.hostname = "pbs-test"
    
    # Network configuration - forward PBS web interface
    pbs.vm.network "forwarded_port", guest: 8007, host: 8007, host_ip: "127.0.0.1"
    
    # VM resources - PBS needs reasonable resources
    # VirtualBox provider (for local development on macOS/Windows)
    pbs.vm.provider "virtualbox" do |vb|
      vb.memory = "2048"
      vb.cpus = 2
      vb.name = "pbs-test-vm"
      
      # Create a virtual disk for ZFS pool (4GB) - for testing datastore creation
      unless File.exist?("./zfs-disk.vdi")
        vb.customize ['createhd', '--filename', './zfs-disk.vdi', '--size', 4096]
      end
      vb.customize ['storageattach', :id, '--storagectl', 'SATA Controller', '--port', 1, '--device', 0, '--type', 'hdd', '--medium', './zfs-disk.vdi']
    end
    
    # Libvirt provider (for Linux/GitHub Actions with KVM support)
    pbs.vm.provider "libvirt" do |lv|
      lv.memory = 2048
      lv.cpus = 2
      lv.machine_type = "q35"
      lv.cpu_mode = "host-passthrough"
      
      # Create a virtual disk for ZFS pool (4GB) - for testing datastore creation
      lv.storage :file, :size => '4G', :device => 'vdb', :allow_existing => true
    end
    
    # Optional: Create a test ZFS pool if additional disk is available
    # The pre-built boxes already have PBS installed and configured
    pbs.vm.provision "shell", inline: <<-SHELL
      # Check if we have an additional disk for ZFS testing
      if [ -b /dev/vdb ]; then
        echo "Found additional disk /dev/vdb, creating test ZFS pool..."
        
        # Create ZFS pool if it doesn't exist
        if ! zpool list testpool >/dev/null 2>&1; then
          zpool create -f testpool /dev/vdb
          echo "✅ Created ZFS pool 'testpool'"
          zpool list testpool
        else
          echo "ZFS pool 'testpool' already exists"
        fi
      elif [ -b /dev/sdb ]; then
        echo "Found additional disk /dev/sdb, creating test ZFS pool..."
        
        # Create ZFS pool if it doesn't exist
        if ! zpool list testpool >/dev/null 2>&1; then
          zpool create -f testpool /dev/sdb
          echo "✅ Created ZFS pool 'testpool'"
          zpool list testpool
        else
          echo "ZFS pool 'testpool' already exists"
        fi
      else
        echo "⚠️  No additional disk found, skipping test ZFS pool creation"
        echo "Available block devices:"
        lsblk
      fi
      
      # Ensure PBS services are running
      systemctl is-active --quiet proxmox-backup.service || systemctl start proxmox-backup.service
      systemctl is-active --quiet proxmox-backup-proxy.service || systemctl start proxmox-backup-proxy.service
      
      echo "PBS is ready!"
      proxmox-backup-manager version
    SHELL
  end
end
