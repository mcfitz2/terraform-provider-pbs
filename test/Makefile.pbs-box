# Makefile for building PBS Vagrant box for testing
# This creates a custom Vagrant box from the PBS ISO that includes ZFS support

.PHONY: help build-pbs-box add-pbs-box clean-pbs-box test-pbs-box

help-pbs:
	@echo "PBS Vagrant Box Builder"
	@echo ""
	@echo "Usage:"
	@echo "  make build-pbs-box    - Build PBS Vagrant box from ISO (one-time, ~20min)"
	@echo "  make add-pbs-box      - Add box to Vagrant (after building)"
	@echo "  make test-pbs-box     - Test the box by starting it"
	@echo "  make clean-pbs-box    - Remove built box and Packer cache"
	@echo ""
	@echo "Quick start:"
	@echo "  1. make build-pbs-box"
	@echo "  2. make add-pbs-box"
	@echo "  3. cp Vagrantfile.pbs-box Vagrantfile"
	@echo "  4. vagrant up"

build-pbs-box: pbs-test.box

pbs-test.box: pbs-box.pkr.hcl
	@echo "Building PBS Vagrant box from ISO..."
	@echo "This will take ~20 minutes..."
	packer init pbs-box.pkr.hcl
	PACKER_LOG=1 PACKER_LOG_PATH=pbs-box.log packer build pbs-box.pkr.hcl
	@echo ""
	@echo "✅ Box built successfully: pbs-test.box"
	@echo "Next step: make add-pbs-box"

add-pbs-box:
	@if [ ! -f pbs-test.box ]; then \
		echo "❌ pbs-test.box not found. Run 'make build-pbs-box' first."; \
		exit 1; \
	fi
	@echo "Adding PBS box to Vagrant..."
	vagrant box add -f pbs-test pbs-test.box
	@echo ""
	@echo "✅ Box added to Vagrant"
	@echo "You can now use it with:"
	@echo "  cp Vagrantfile.pbs-box Vagrantfile"
	@echo "  vagrant up"

test-pbs-box: add-pbs-box
	@echo "Testing PBS box..."
	@if [ -f Vagrantfile ]; then \
		mv Vagrantfile Vagrantfile.backup; \
	fi
	cp Vagrantfile.pbs-box Vagrantfile
	vagrant up --provider=libvirt || vagrant up --provider=virtualbox
	@echo ""
	@echo "Testing PBS API..."
	sleep 10
	curl -k https://localhost:8007 && echo "✅ PBS is responding" || echo "❌ PBS not responding"
	@echo ""
	@echo "Cleaning up test..."
	vagrant destroy -f
	@if [ -f Vagrantfile.backup ]; then \
		mv Vagrantfile.backup Vagrantfile; \
	else \
		rm Vagrantfile; \
	fi

clean-pbs-box:
	@echo "Cleaning up PBS box artifacts..."
	rm -f pbs-test.box
	rm -f pbs-box.log
	rm -rf packer_cache
	rm -rf output-pbs-test
	@echo "✅ Cleaned"
